import{q as se,N as ie,Q as oe,U as ne,W as ae,X as he}from"./VendorConfigurationMovie-BIxuM71E.js";import"./client-B3aq8qpT.js";class K extends Error{constructor(e,t){super(e),this.name="ParseError",this.type=t.type,this.field=t.field,this.value=t.value,this.line=t.line}}function z(n){}function ce(n){if(typeof n=="function")throw new TypeError("`callbacks` must be an object, got a function instead. Did you mean `{onEvent: fn}`?");const{onEvent:e=z,onError:t=z,onRetry:r=z,onComment:i}=n;let s="",o=!0,c,h="",u="";function L(l){const f=o?l.replace(/^\xEF\xBB\xBF/,""):l,[y,H]=le(`${s}${f}`);for(const D of y)O(D);s=H,o=!1}function O(l){if(l===""){$();return}if(l.startsWith(":")){i&&i(l.slice(l.startsWith(": ")?2:1));return}const f=l.indexOf(":");if(f!==-1){const y=l.slice(0,f),H=l[f+1]===" "?2:1,D=l.slice(f+H);x(y,D,l);return}x(l,"",l)}function x(l,f,y){switch(l){case"event":u=f;break;case"data":h=`${h}${f}
`;break;case"id":c=f.includes("\0")?void 0:f;break;case"retry":/^\d+$/.test(f)?r(parseInt(f,10)):t(new K(`Invalid \`retry\` value: "${f}"`,{type:"invalid-retry",value:f,line:y}));break;default:t(new K(`Unknown field "${l.length>20?`${l.slice(0,20)}â€¦`:l}"`,{type:"unknown-field",field:l,value:f,line:y}));break}}function $(){h.length>0&&e({id:c,event:u||void 0,data:h.endsWith(`
`)?h.slice(0,-1):h}),c=void 0,h="",u=""}function A(l={}){s&&l.consume&&O(s),o=!0,c=void 0,h="",u="",s=""}return{feed:L,reset:A}}function le(n){const e=[];let t="",r=0;for(;r<n.length;){const i=n.indexOf("\r",r),s=n.indexOf(`
`,r);let o=-1;if(i!==-1&&s!==-1?o=Math.min(i,s):i!==-1?o=i:s!==-1&&(o=s),o===-1){t=n.slice(r);break}else{const c=n.slice(r,o);e.push(c),r=o+1,n[r-1]==="\r"&&n[r]===`
`&&r++}}return[e,t]}class Y extends Event{constructor(e,t){var r,i;super(e),this.code=(r=t==null?void 0:t.code)!=null?r:void 0,this.message=(i=t==null?void 0:t.message)!=null?i:void 0}[Symbol.for("nodejs.util.inspect.custom")](e,t,r){return r(ee(this),t)}[Symbol.for("Deno.customInspect")](e,t){return e(ee(this),t)}}function de(n){const e=globalThis.DOMException;return typeof e=="function"?new e(n,"SyntaxError"):new SyntaxError(n)}function V(n){return n instanceof Error?"errors"in n&&Array.isArray(n.errors)?n.errors.map(V).join(", "):"cause"in n&&n.cause instanceof Error?`${n}: ${V(n.cause)}`:n.message:`${n}`}function ee(n){return{type:n.type,message:n.message,code:n.code,defaultPrevented:n.defaultPrevented,cancelable:n.cancelable,timeStamp:n.timeStamp}}var re=n=>{throw TypeError(n)},X=(n,e,t)=>e.has(n)||re("Cannot "+t),a=(n,e,t)=>(X(n,e,"read from private field"),t?t.call(n):e.get(n)),p=(n,e,t)=>e.has(n)?re("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),d=(n,e,t,r)=>(X(n,e,"write to private field"),e.set(n,t),t),v=(n,e,t)=>(X(n,e,"access private method"),t),_,g,m,N,W,R,k,U,E,T,C,S,P,w,q,G,B,te,Z,j,I,J,Q;class M extends EventTarget{constructor(e,t){var r,i;super(),p(this,w),this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,p(this,_),p(this,g),p(this,m),p(this,N),p(this,W),p(this,R),p(this,k),p(this,U,null),p(this,E),p(this,T),p(this,C,null),p(this,S,null),p(this,P,null),p(this,G,async s=>{var o;a(this,T).reset();const{body:c,redirected:h,status:u,headers:L}=s;if(u===204){v(this,w,I).call(this,"Server sent HTTP 204, not reconnecting",204),this.close();return}if(h?d(this,m,new URL(s.url)):d(this,m,void 0),u!==200){v(this,w,I).call(this,`Non-200 status code (${u})`,u);return}if(!(L.get("content-type")||"").startsWith("text/event-stream")){v(this,w,I).call(this,'Invalid content type, expected "text/event-stream"',u);return}if(a(this,_)===this.CLOSED)return;d(this,_,this.OPEN);const O=new Event("open");if((o=a(this,P))==null||o.call(this,O),this.dispatchEvent(O),typeof c!="object"||!c||!("getReader"in c)){v(this,w,I).call(this,"Invalid response body, expected a web ReadableStream",u),this.close();return}const x=new TextDecoder,$=c.getReader();let A=!0;do{const{done:l,value:f}=await $.read();f&&a(this,T).feed(x.decode(f,{stream:!l})),l&&(A=!1,a(this,T).reset(),v(this,w,J).call(this))}while(A)}),p(this,B,s=>{d(this,E,void 0),!(s.name==="AbortError"||s.type==="aborted")&&v(this,w,J).call(this,V(s))}),p(this,Z,s=>{typeof s.id=="string"&&d(this,U,s.id);const o=new MessageEvent(s.event||"message",{data:s.data,origin:a(this,m)?a(this,m).origin:a(this,g).origin,lastEventId:s.id||""});a(this,S)&&(!s.event||s.event==="message")&&a(this,S).call(this,o),this.dispatchEvent(o)}),p(this,j,s=>{d(this,R,s)}),p(this,Q,()=>{d(this,k,void 0),a(this,_)===this.CONNECTING&&v(this,w,q).call(this)});try{if(e instanceof URL)d(this,g,e);else if(typeof e=="string")d(this,g,new URL(e,ue()));else throw new Error("Invalid URL")}catch{throw de("An invalid or illegal string was specified")}d(this,T,ce({onEvent:a(this,Z),onRetry:a(this,j)})),d(this,_,this.CONNECTING),d(this,R,3e3),d(this,W,(r=t==null?void 0:t.fetch)!=null?r:globalThis.fetch),d(this,N,(i=t==null?void 0:t.withCredentials)!=null?i:!1),v(this,w,q).call(this)}get readyState(){return a(this,_)}get url(){return a(this,g).href}get withCredentials(){return a(this,N)}get onerror(){return a(this,C)}set onerror(e){d(this,C,e)}get onmessage(){return a(this,S)}set onmessage(e){d(this,S,e)}get onopen(){return a(this,P)}set onopen(e){d(this,P,e)}addEventListener(e,t,r){const i=t;super.addEventListener(e,i,r)}removeEventListener(e,t,r){const i=t;super.removeEventListener(e,i,r)}close(){a(this,k)&&clearTimeout(a(this,k)),a(this,_)!==this.CLOSED&&(a(this,E)&&a(this,E).abort(),d(this,_,this.CLOSED),d(this,E,void 0))}}_=new WeakMap,g=new WeakMap,m=new WeakMap,N=new WeakMap,W=new WeakMap,R=new WeakMap,k=new WeakMap,U=new WeakMap,E=new WeakMap,T=new WeakMap,C=new WeakMap,S=new WeakMap,P=new WeakMap,w=new WeakSet,q=function(){d(this,_,this.CONNECTING),d(this,E,new AbortController),a(this,W)(a(this,g),v(this,w,te).call(this)).then(a(this,G)).catch(a(this,B))},G=new WeakMap,B=new WeakMap,te=function(){var n;const e={mode:"cors",redirect:"follow",headers:{Accept:"text/event-stream",...a(this,U)?{"Last-Event-ID":a(this,U)}:void 0},cache:"no-store",signal:(n=a(this,E))==null?void 0:n.signal};return"window"in globalThis&&(e.credentials=this.withCredentials?"include":"same-origin"),e},Z=new WeakMap,j=new WeakMap,I=function(n,e){var t;a(this,_)!==this.CLOSED&&d(this,_,this.CLOSED);const r=new Y("error",{code:e,message:n});(t=a(this,C))==null||t.call(this,r),this.dispatchEvent(r)},J=function(n,e){var t;if(a(this,_)===this.CLOSED)return;d(this,_,this.CONNECTING);const r=new Y("error",{code:e,message:n});(t=a(this,C))==null||t.call(this,r),this.dispatchEvent(r),d(this,k,setTimeout(a(this,Q),a(this,R)))},Q=new WeakMap,M.CONNECTING=0,M.OPEN=1,M.CLOSED=2;function ue(){const n="document"in globalThis?globalThis.document:void 0;return n&&typeof n=="object"&&"baseURI"in n&&typeof n.baseURI=="string"?n.baseURI:void 0}class b extends Error{constructor(e){super(e??"Unauthorized")}}async function F(n,{serverUrl:e,authorizationCode:t}){const r=await fe(e);let i=await Promise.resolve(n.clientInformation());if(!i){if(t!==void 0)throw new Error("Existing OAuth client information is required when exchanging an authorization code");if(!n.saveClientInformation)throw new Error("OAuth client information must be saveable for dynamic registration");const h=await ve(e,{metadata:r,clientMetadata:n.clientMetadata});await n.saveClientInformation(h),i=h}if(t!==void 0){const h=await n.codeVerifier(),u=await _e(e,{metadata:r,clientInformation:i,authorizationCode:t,codeVerifier:h,redirectUri:n.redirectUrl});return await n.saveTokens(u),"AUTHORIZED"}const s=await n.tokens();if(s!=null&&s.refresh_token)try{const h=await we(e,{metadata:r,clientInformation:i,refreshToken:s.refresh_token});return await n.saveTokens(h),"AUTHORIZED"}catch(h){console.error("Could not refresh OAuth tokens:",h)}const{authorizationUrl:o,codeVerifier:c}=await pe(e,{metadata:r,clientInformation:i,redirectUrl:n.redirectUrl});return await n.saveCodeVerifier(c),await n.redirectToAuthorization(o),"REDIRECT"}async function fe(n,e){var t;const r=new URL("/.well-known/oauth-authorization-server",n);let i;try{i=await fetch(r,{headers:{"MCP-Protocol-Version":(t=e==null?void 0:e.protocolVersion)!==null&&t!==void 0?t:se}})}catch(s){if(s instanceof TypeError)i=await fetch(r);else throw s}if(i.status!==404){if(!i.ok)throw new Error(`HTTP ${i.status} trying to load well-known OAuth metadata`);return ie.parse(await i.json())}}async function pe(n,{metadata:e,clientInformation:t,redirectUrl:r}){const i="code",s="S256";let o;if(e){if(o=new URL(e.authorization_endpoint),!e.response_types_supported.includes(i))throw new Error(`Incompatible auth server: does not support response type ${i}`);if(!e.code_challenge_methods_supported||!e.code_challenge_methods_supported.includes(s))throw new Error(`Incompatible auth server: does not support code challenge method ${s}`)}else o=new URL("/authorize",n);const c=await ae(),h=c.code_verifier,u=c.code_challenge;return o.searchParams.set("response_type",i),o.searchParams.set("client_id",t.client_id),o.searchParams.set("code_challenge",u),o.searchParams.set("code_challenge_method",s),o.searchParams.set("redirect_uri",String(r)),{authorizationUrl:o,codeVerifier:h}}async function _e(n,{metadata:e,clientInformation:t,authorizationCode:r,codeVerifier:i,redirectUri:s}){const o="authorization_code";let c;if(e){if(c=new URL(e.token_endpoint),e.grant_types_supported&&!e.grant_types_supported.includes(o))throw new Error(`Incompatible auth server: does not support grant type ${o}`)}else c=new URL("/token",n);const h=new URLSearchParams({grant_type:o,client_id:t.client_id,code:r,code_verifier:i,redirect_uri:String(s)});t.client_secret&&h.set("client_secret",t.client_secret);const u=await fetch(c,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:h});if(!u.ok)throw new Error(`Token exchange failed: HTTP ${u.status}`);return ne.parse(await u.json())}async function we(n,{metadata:e,clientInformation:t,refreshToken:r}){const i="refresh_token";let s;if(e){if(s=new URL(e.token_endpoint),e.grant_types_supported&&!e.grant_types_supported.includes(i))throw new Error(`Incompatible auth server: does not support grant type ${i}`)}else s=new URL("/token",n);const o=new URLSearchParams({grant_type:i,client_id:t.client_id,refresh_token:r});t.client_secret&&o.set("client_secret",t.client_secret);const c=await fetch(s,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o});if(!c.ok)throw new Error(`Token refresh failed: HTTP ${c.status}`);return ne.parse(await c.json())}async function ve(n,{metadata:e,clientMetadata:t}){let r;if(e){if(!e.registration_endpoint)throw new Error("Incompatible auth server: does not support dynamic client registration");r=new URL(e.registration_endpoint)}else r=new URL("/register",n);const i=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!i.ok)throw new Error(`Dynamic client registration failed: HTTP ${i.status}`);return oe.parse(await i.json())}class Ee extends Error{constructor(e,t,r){super(`SSE error: ${t}`),this.code=e,this.event=r}}class me{constructor(e,t){this._url=e,this._eventSourceInit=t==null?void 0:t.eventSourceInit,this._requestInit=t==null?void 0:t.requestInit,this._authProvider=t==null?void 0:t.authProvider}async _authThenStart(){var e;if(!this._authProvider)throw new b("No auth provider");let t;try{t=await F(this._authProvider,{serverUrl:this._url})}catch(r){throw(e=this.onerror)===null||e===void 0||e.call(this,r),r}if(t!=="AUTHORIZED")throw new b;return await this._startOrAuth()}async _commonHeaders(){const e={};if(this._authProvider){const t=await this._authProvider.tokens();t&&(e.Authorization=`Bearer ${t.access_token}`)}return e}_startOrAuth(){return new Promise((e,t)=>{var r;this._eventSource=new M(this._url.href,(r=this._eventSourceInit)!==null&&r!==void 0?r:{fetch:(i,s)=>this._commonHeaders().then(o=>fetch(i,{...s,headers:{...o,Accept:"text/event-stream"}}))}),this._abortController=new AbortController,this._eventSource.onerror=i=>{var s;if(i.code===401&&this._authProvider){this._authThenStart().then(e,t);return}const o=new Ee(i.code,i.message,i);t(o),(s=this.onerror)===null||s===void 0||s.call(this,o)},this._eventSource.onopen=()=>{},this._eventSource.addEventListener("endpoint",i=>{var s;const o=i;try{if(this._endpoint=new URL(o.data,this._url),this._endpoint.origin!==this._url.origin)throw new Error(`Endpoint origin does not match connection origin: ${this._endpoint.origin}`)}catch(c){t(c),(s=this.onerror)===null||s===void 0||s.call(this,c),this.close();return}e()}),this._eventSource.onmessage=i=>{var s,o;const c=i;let h;try{h=he.parse(JSON.parse(c.data))}catch(u){(s=this.onerror)===null||s===void 0||s.call(this,u);return}(o=this.onmessage)===null||o===void 0||o.call(this,h)}})}async start(){if(this._eventSource)throw new Error("SSEClientTransport already started! If using Client class, note that connect() calls start() automatically.");return await this._startOrAuth()}async finishAuth(e){if(!this._authProvider)throw new b("No auth provider");if(await F(this._authProvider,{serverUrl:this._url,authorizationCode:e})!=="AUTHORIZED")throw new b("Failed to authorize")}async close(){var e,t,r;(e=this._abortController)===null||e===void 0||e.abort(),(t=this._eventSource)===null||t===void 0||t.close(),(r=this.onclose)===null||r===void 0||r.call(this)}async send(e){var t,r,i;if(!this._endpoint)throw new Error("Not connected");try{const s=await this._commonHeaders(),o=new Headers({...s,...(t=this._requestInit)===null||t===void 0?void 0:t.headers});o.set("content-type","application/json");const c={...this._requestInit,method:"POST",headers:o,body:JSON.stringify(e),signal:(r=this._abortController)===null||r===void 0?void 0:r.signal},h=await fetch(this._endpoint,c);if(!h.ok){if(h.status===401&&this._authProvider){if(await F(this._authProvider,{serverUrl:this._url})!=="AUTHORIZED")throw new b;return this.send(e)}const u=await h.text().catch(()=>null);throw new Error(`Error POSTing to endpoint (HTTP ${h.status}): ${u}`)}}catch(s){throw(i=this.onerror)===null||i===void 0||i.call(this,s),s}}}export{me as SSEClientTransport,Ee as SseError};
